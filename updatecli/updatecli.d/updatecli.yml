# This small test makes sure that updatecli is working properly on a repo.
# In the future, more useful files should be added to this directory.
---
name: "Introduce updatecli to repo and validate basic functionality"
# Make sure we can pull in github repos from multiple orgs
scms:
  klipper-lb:
    kind: "github"
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      username: "{{ requiredEnv .github.username }}"
      token: '{{ requiredEnv .github.token }}'
      owner: "{{ .klipper-lb.org }}"
      repository: "{{ .klipper-lb.repo }}"
      branch: "{{ .klipper-lb.branch }}"
  go:
    kind: "github"
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      username: "{{ requiredEnv .github.username }}"
      token: '{{ requiredEnv .github.token }}'
      owner: "{{ .go.org }}"
      repository: "{{ .go.repo }}"
      branch: "{{ .go.branch }}"

sources:
  # validate gittag parsing external public repos
  goTag:
    name: "Get Go 1.20.2 tag"
    kind: "gittag"
    scmid: "go"
    spec:
      versionfilter:
        kind: "regex"
        pattern: '^go1\.20\.2$'

# Validate read access to local repo
## continue to targets if the go version in the validate file doesn't match the goTag source
conditions:
  testVersionShouldMatchGoTag:
    name: test version should match go tag
    kind: yaml
    sourceid: goTag
    spec:
      file: "updatecli/validate.yml"
      key: version
    failwhen: true #if set to true, continue to targets when condition is true rather than false

# Validate the ability to generate branches, commits, what the commits look like, and what branches look like
## allow validation of workflow to delete unused branch after merge
## generate a commit on a branch named updatecli_<256 sha of change>
## the commit message will be automatically generated by updatecli based on the change
targets:
  updateValidateFile:
    name: "Update the version in the validate file"
    kind: "yaml"
    scmid: "klipper-lb"
    sourceid: goTag
    spec:
      file: "updatecli/validate.yml"
      key: version

# Validate generating a pull request
actions:
  # create a pull request which is not allowed to automerge
  # the title matches the commit message
  github:
    kind: "github/pullrequest"
    scmid: "klipper-lb"
    spec:
      automerge: false
      draft: false
      mergemethod: squash
      parent: false # this would allow for making a PR to an upstream fork, if we ran updatecli from a fork
